---
import MainLayout from "@layouts/MainLayout.astro";
import { Picture } from "astro-imagetools/components";
---

<MainLayout>
  <header>
    <h1 class="sr-only">Login page</h1>

    <section class="w-48 mx-auto my-8">
      <Picture
        breakpoints={[768]}
        objectFit="contain"
        src="/images/logo/logo-horizontal.png"
        alt="logo"
      />
    </section>
  </header>

  <section class="max-w-xl mx-auto my-8 px-4">
    <section class="bg-white rounded-3xl shadow-lg overflow-hidden p-8">
      <header>
        <h2 class="text-2xl">登录到您的帐户</h2>
      </header>

      <section class="mt-4 mx-auto">
        <form data-login-form class="-mx-1">
          <label class="flex flex-col p-1">
            <span class="text-xs font-bold">用户名</span>
            <input
              required
              name="username"
              class="border rounded-md p-2"
              placeholder="用户名"
            />
          </label>
          <label class="flex flex-col p-1">
            <span class="text-xs font-bold">密码</span>
            <input
              required
              name="password"
              type="password"
              class="border rounded-md p-2"
              placeholder="密码"
            />
            <a
              href="/"
              class="text-xs text-p ml-auto block w-fit hover:underline"
            >
              忘记密码？
            </a>
          </label>

          <footer class="p-1 mt-2 space-y-2">
            <button
              class="mx-auto text-sm w-full block p-2 rounded-md bg-p text-white transition hover:bg-p-600"
            >
              登入
            </button>
            <button
              class="mx-auto text-sm w-full block p-2 rounded-md bg-gray-200 hover:bg-gray-300"
            >
              使用 WhatsApp 登录
            </button>

            <section class="pt-2 text-xs flex justify-between">
              <div class="flex flex-wrap w-1/2">
                <p class="mr-1">非会员？</p>
                <a class="text-p hover:underline" href="/register">现在加入</a>
              </div>

              <div class="flex justify-end flex-wrap w-1/2">
                <p class="mr-1">需要帮忙？</p>
                <a class="text-p hover:underline">联系我们！</a>
              </div>
            </section>
          </footer>
        </form>
      </section>
    </section>
  </section>
</MainLayout>

<script>
  import { authGetProfile, authLogin } from "@services/authService";
  import { utilCookieSave } from "@services/utilService";
  import type { UserLogin } from "../../../esl-workers/src/domain/models/UserModel";

  const form = document.querySelector<HTMLFormElement>("[data-login-form]");

  (async () => {
    const user = await authGetProfile();
    if (user) {
      utilCookieSave("userId", user.id);
      window.location.href = "/profile";
    }
  })();

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries()) as UserLogin;

    const response = await authLogin(data);

    if (!response) {
      alert("Login failed!");
    } else {
      // alert("Login successful!");
      window.location.href = "/profile";
    }
  });
</script>
